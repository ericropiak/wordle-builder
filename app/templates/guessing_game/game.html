{% extends "guessing_game/base.html" %}

{% block guessing_game_content %}
  <h2>{{ game.name }}</h2>
  {% if game_day_date %}
    <form method="POST" action="{{ url_for('.guess_entity', game_id=game.hashed_id) }}" autocomplete="off">
      {{ guessing_form.hidden_tag() }}
      <div class="row no-gutters mt-2" style="height: 50px;">
        <div class="col">
          <input id="guess-autocomplete" class="h-100 w-100" style="border-radius: 5px 0px 0px 5px; font-size: 20px; padding-left: 10px;">
          <div class="d-none">
            {{ guessing_form.entity_id }}
          </div>
        </div>
        <div class="col col-auto">
          <button id="submit-guess" type="submit" disabled="true" class="btn btn-primary h-100" style="border-radius: 0px 5px 5px 0px;">Guess!</button>
        </div>
      </div>
      {% for previous_attempt_data in previous_attempts %}
        {% set previous_attempt = previous_attempt_data.previous_attempt %}
        {% set facet_diffs = previous_attempt_data.facet_diffs %}
        <div class="row">
          <div class="col">
            <div class="row">
              <div class="col">{{ previous_attempt.entity.name }}</div>
            </div>
            <div class="row">
              {% for facet_diff in facet_diffs %}
                {% set facet = facet_diff[0] %}
                {% set value = facet_diff[1] %}
                {% set result = facet_diff[2] %}

                {% if result == enums.GuessingGameFacetComparisonResult.CORRECT %}
                  {% set facet_class = 'correct-facet' %}
                {% elif result in [enums.GuessingGameFacetComparisonResult.CLOSE_LOW, enums.GuessingGameFacetComparisonResult.CLOSE_HIGH] %}
                  {% set facet_class = 'close-facet' %}
                {% else %}
                  {% set facet_class = 'incorrect-facet' %}
                {% endif %}

                <div class="col {{ facet_class }}">
                  <div class="row">
                    <div class="col">
                      {{ facet.label }}
                    </div>
                  </div>
                  <div class="row">
                    <div class="col">
                      {{ value }}
                      {% if result in [enums.GuessingGameFacetComparisonResult.LOW, enums.GuessingGameFacetComparisonResult.CLOSE_LOW] %}
                        ^
                      {% elif result in [enums.GuessingGameFacetComparisonResult.HIGH, enums.GuessingGameFacetComparisonResult.CLOSE_HIGH] %}
                        \/
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endfor %}
    </form>
  {% else %}
    There is no puzzle available for today, please check back in tomorrow (unless tomorrow is Sunday).
  {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  <script>
    $( "#guess-autocomplete" ).autocomplete({
      source: "{{ url_for('guessing-game.entity_autocomplete', game_id=game.hashed_id)}}",
      minLength: 2,
      select: ( event, ui ) => {
        $('#{{ guessing_form.entity_id.id }}').val(ui.item.id);
        $('#submit-guess').prop('disabled', false);
      },
      search: () => {
        $('#submit-guess').prop('disabled', true);
      }
    });
  </script>

{% endblock %}

{% block style %}
  <style type="text/css">
    .correct-facet {
      background-color: greenyellow;
    }
    .close-facet {
      background-color: yellow;
    }
    .incorrect-facet {
      background-color: gray;
    }
  </style>

{% endblock %}
